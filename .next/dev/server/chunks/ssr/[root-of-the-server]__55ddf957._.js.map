{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///c:/Users/User/Desktop/AmzonTrackr/lib/models/product.model.ts"],"sourcesContent":["import mongoose from 'mongoose';\r\n\r\nconst productSchema = new mongoose.Schema({\r\n  url: { type: String, required: true, unique: true, index: true },\r\n  currency: { type: String, required: true },\r\n  image: { type: String, required: true },\r\n  title: { type: String, required: true },\r\n  currentPrice: { type: Number, required: true },\r\n  originalPrice: { type: Number, required: true },\r\n  priceHistory: [\r\n    { \r\n      price: { type: Number, required: true },\r\n      date: { type: Date, default: Date.now }\r\n    },\r\n  ],\r\n  lowestPrice: { type: Number },\r\n  highestPrice: { type: Number },\r\n  averagePrice: { type: Number },\r\n  discountRate: { type: Number },\r\n  description: { type: String },\r\n  category: { type: String },\r\n  reviewsCount: { type: Number },\r\n  isOutOfStock: { type: Boolean, default: false },\r\n  users: [\r\n    {email: { type: String, required: true}}\r\n  ],\r\n}, { timestamps: true });\r\n\r\nconst Product = mongoose.models.Product || mongoose.model('Product', productSchema);\r\n\r\nexport default Product;"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,gBAAgB,IAAI,oHAAQ,CAAC,MAAM,CAAC;IACxC,KAAK;QAAE,MAAM;QAAQ,UAAU;QAAM,QAAQ;QAAM,OAAO;IAAK;IAC/D,UAAU;QAAE,MAAM;QAAQ,UAAU;IAAK;IACzC,OAAO;QAAE,MAAM;QAAQ,UAAU;IAAK;IACtC,OAAO;QAAE,MAAM;QAAQ,UAAU;IAAK;IACtC,cAAc;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC7C,eAAe;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC9C,cAAc;QACZ;YACE,OAAO;gBAAE,MAAM;gBAAQ,UAAU;YAAK;YACtC,MAAM;gBAAE,MAAM;gBAAM,SAAS,KAAK,GAAG;YAAC;QACxC;KACD;IACD,aAAa;QAAE,MAAM;IAAO;IAC5B,cAAc;QAAE,MAAM;IAAO;IAC7B,cAAc;QAAE,MAAM;IAAO;IAC7B,cAAc;QAAE,MAAM;IAAO;IAC7B,aAAa;QAAE,MAAM;IAAO;IAC5B,UAAU;QAAE,MAAM;IAAO;IACzB,cAAc;QAAE,MAAM;IAAO;IAC7B,cAAc;QAAE,MAAM;QAAS,SAAS;IAAM;IAC9C,OAAO;QACL;YAAC,OAAO;gBAAE,MAAM;gBAAQ,UAAU;YAAI;QAAC;KACxC;AACH,GAAG;IAAE,YAAY;AAAK;AAEtB,MAAM,UAAU,oHAAQ,CAAC,MAAM,CAAC,OAAO,IAAI,oHAAQ,CAAC,KAAK,CAAC,WAAW;uCAEtD"}},
    {"offset": {"line": 97, "column": 0}, "map": {"version":3,"sources":["file:///c:/Users/User/Desktop/AmzonTrackr/lib/mongoose.ts"],"sourcesContent":["import mongoose from 'mongoose';\r\n\r\nlet isConnected = false;// Variable to track the connection status\r\n\r\nexport const connectToDB = async () => {\r\n  mongoose.set('strictQuery', true);\r\n\r\n  if(!process.env.MONGODB_URL) return console.log('MONGODB_URL is not defined');\r\n\r\n  if(isConnected) return console.log('=> using existing database connection');\r\n\r\n  try {\r\n    await mongoose.connect(process.env.MONGODB_URL, {\r\n      serverSelectionTimeoutMS: 20000, // Increase timeout to 20 seconds\r\n    });\r\n\r\n    isConnected = true;\r\n\r\n    console.log('MongoDB Connected');\r\n  } catch (error) {\r\n    console.log(error)\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,cAAc,OAAM,0CAA0C;AAE3D,MAAM,cAAc;IACzB,oHAAQ,CAAC,GAAG,CAAC,eAAe;IAE5B,IAAG,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE,OAAO,QAAQ,GAAG,CAAC;IAEhD,IAAG,aAAa,OAAO,QAAQ,GAAG,CAAC;IAEnC,IAAI;QACF,MAAM,oHAAQ,CAAC,OAAO,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;YAC9C,0BAA0B;QAC5B;QAEA,cAAc;QAEd,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,OAAO;QACd,QAAQ,GAAG,CAAC;IACd;AACF"}},
    {"offset": {"line": 194, "column": 0}, "map": {"version":3,"sources":["file:///c:/Users/User/Desktop/AmzonTrackr/lib/utils.ts"],"sourcesContent":["import { PriceHistoryItem, Product } from \"@/types\";\r\n\r\nconst Notification = {\r\n  WELCOME: 'WELCOME',\r\n  CHANGE_OF_STOCK: 'CHANGE_OF_STOCK',\r\n  LOWEST_PRICE: 'LOWEST_PRICE',\r\n  THRESHOLD_MET: 'THRESHOLD_MET',\r\n}\r\n\r\nconst THRESHOLD_PERCENTAGE = 40;\r\n\r\n// Extracts and returns the price from a list of possible elements.\r\nexport function extractPrice(...elements: any) {\r\n  for (const element of elements) {\r\n    const priceText = element.text().trim();\r\n\r\n    if(priceText) {\r\n      const cleanPrice = priceText.replace(/[^\\d.]/g, '');\r\n\r\n      let firstPrice; \r\n\r\n      if (cleanPrice) {\r\n        firstPrice = cleanPrice.match(/\\d+\\.\\d{2}/)?.[0];\r\n      } \r\n\r\n      return firstPrice || cleanPrice;\r\n    }\r\n  }\r\n\r\n  return '';\r\n}\r\n\r\n// Extracts and returns the currency symbol from an element.\r\nexport function extractCurrency(element: any) {\r\n  const currencyText = element.text().trim().slice(0, 1);\r\n  return currencyText ? currencyText : \"\";\r\n}\r\n\r\n// Extracts description from two possible elements from amazon\r\nexport function extractDescription($: any): string {\r\n    // Extracting description from common Amazon selectors\r\n    const selectors = [\r\n      '#feature-bullets .a-list-item',\r\n      '#productDescription p',\r\n      '.a-unordered-list .a-list-item'\r\n    ];\r\n  \r\n    let description = '';\r\n  \r\n    selectors.forEach((selector) => {\r\n      $(selector).each((i: number, el: any) => {\r\n        const text = $(el).text().trim();\r\n        if (text.length > 0 && !text.toLowerCase().includes('sort reviews by') && !text.match(/^\\d(\\.\\d)?$/)) {\r\n          description += `â€¢ ${text}\\n`;\r\n        }\r\n      });\r\n    });\r\n  \r\n    // Truncate to 300 words if necessary, ending at the next full stop\r\n    const maxWords = 300;\r\n    const words = description.split(/\\s+/);\r\n    if (words.length > maxWords) {\r\n        let truncatedText = words.slice(0, maxWords).join(' ');\r\n        const lastPeriodIndex = truncatedText.lastIndexOf('.');\r\n    if (lastPeriodIndex !== -1) {\r\n      truncatedText = truncatedText.slice(0, lastPeriodIndex + 1);\r\n    }\r\n    description = truncatedText + '...';\r\n  }\r\n\r\n  return description.trim();\r\n  }\r\n  \r\n\r\n// Get reviews and stars\r\nexport function extractReviewsCount(...elements: any[]): string {\r\n    for (const element of elements) {\r\n      const text = element.text().trim();\r\n      const count = text.replace(/[^0-9]/g, '');\r\n      if (count) {\r\n        // Remove duplication by taking the first half of the string\r\n        return count.slice(0, count.length / 2);\r\n      }\r\n    }\r\n    return '';\r\n  }\r\n\r\n  export function extractStars(...elements: any) {\r\n    for (const element of elements) {\r\n      // Get the rating text, usually in a format like \"4.5 out of 5 stars\"\r\n      const ratingText = element.text().trim();\r\n  \r\n      if (ratingText) {\r\n        // Extract the numeric value from the rating string\r\n        const ratingMatch = ratingText.match(/(\\d+(\\.\\d+)?)/);\r\n  \r\n        if (ratingMatch) {\r\n          return parseFloat(ratingMatch[0]);\r\n        }\r\n      }\r\n    }\r\n  \r\n    return '';\r\n  }\r\n  \r\n  export function extractFiveStarPercentage(...elements: any) {\r\n    for (const element of elements) {\r\n      // Get the text content that usually contains the percentage, like \"80% 5 star\"\r\n      const percentageText = element.text().trim();\r\n  \r\n      if (percentageText) {\r\n        // Extract the numeric percentage value (e.g., \"80%\")\r\n        const percentageMatch = percentageText.match(/(\\d+(\\.\\d+)?)%/);\r\n  \r\n        if (percentageMatch) {\r\n          return parseFloat(percentageMatch[1]);\r\n        }\r\n      }\r\n    }\r\n  \r\n    return '';\r\n  }\r\n  \r\n\r\nexport function getHighestPrice(priceList: PriceHistoryItem[]) {\r\n  let highestPrice = priceList[0];\r\n\r\n  for (let i = 0; i < priceList.length; i++) {\r\n    if (priceList[i].price > highestPrice.price) {\r\n      highestPrice = priceList[i];\r\n    }\r\n  }\r\n\r\n  return highestPrice.price;\r\n}\r\n\r\nexport function getLowestPrice(priceList: PriceHistoryItem[]) {\r\n  let lowestPrice = priceList[0];\r\n\r\n  for (let i = 0; i < priceList.length; i++) {\r\n    if (priceList[i].price < lowestPrice.price) {\r\n      lowestPrice = priceList[i];\r\n    }\r\n  }\r\n\r\n  return lowestPrice.price;\r\n}\r\n\r\nexport function getAveragePrice(priceList: PriceHistoryItem[]) {\r\n  const sumOfPrices = priceList.reduce((acc, curr) => acc + curr.price, 0);\r\n  const averagePrice = sumOfPrices / priceList.length || 0;\r\n\r\n  return averagePrice;\r\n}\r\n\r\nexport const getEmailNotifType = (\r\n  scrapedProduct: Product,\r\n  currentProduct: Product\r\n) => {\r\n  const lowestPrice = getLowestPrice(currentProduct.priceHistory);\r\n  \r\n  if (scrapedProduct.currentPrice < lowestPrice) {\r\n    return Notification.LOWEST_PRICE as keyof typeof Notification;\r\n  }\r\n  if (!scrapedProduct.isOutOfStock && currentProduct.isOutOfStock) {\r\n    return Notification.CHANGE_OF_STOCK as keyof typeof Notification;\r\n  }\r\n  if (scrapedProduct.discountRate >= THRESHOLD_PERCENTAGE) {\r\n    return Notification.THRESHOLD_MET as keyof typeof Notification;\r\n  }\r\n  \r\n  return null;\r\n};\r\nexport const formatNumber = (num: number = 0) => {\r\n  return num.toLocaleString(undefined, {\r\n    minimumFractionDigits: 0,\r\n    maximumFractionDigits: 0,\r\n  });\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 357, "column": 0}, "map": {"version":3,"sources":["file:///c:/Users/User/Desktop/AmzonTrackr/lib/scraper/index.ts"],"sourcesContent":["\"use server\"\r\n\r\nimport axios from 'axios';\r\nimport * as cheerio from 'cheerio';\r\nimport { extractCurrency, extractDescription, extractPrice, extractStars, extractFiveStarPercentage } from '../utils';\r\n\r\nexport async function scrapeAmazonProduct(url: string) {\r\n  if(!url) return;\r\n\r\n  // BrightData proxy configuration\r\n  const username = String(process.env.BRIGHT_DATA_USERNAME);\r\n  const password = String(process.env.BRIGHT_DATA_PASSWORD);\r\n  const port = 22225;\r\n  const session_id = (1000000 * Math.random()) | 0;\r\n\r\n  const options = {\r\n    auth: {\r\n      username: `${username}-session-${session_id}`,\r\n      password,\r\n    },\r\n    host: 'brd.superproxy.io',\r\n    port,\r\n    rejectUnauthorized: false,\r\n  }\r\n\r\n  try {\r\n    // Fetch the product page\r\n    const response = await axios.get(url, options);\r\n    const $ = cheerio.load(response.data);\r\n\r\n    // Extract the product title\r\n    const title = $('#productTitle').text().trim();\r\n    const currentPrice = extractPrice(\r\n      $('.priceToPay span.a-price-whole'),\r\n      $('.a.size.base.a-color-price'),\r\n      $('.a-button-selected .a-color-base'),\r\n    );\r\n\r\n    const originalPrice = extractPrice(\r\n      $('#priceblock_ourprice'),\r\n      $('.a-price.a-text-price span.a-offscreen'),\r\n      $('#listPrice'),\r\n      $('#priceblock_dealprice'),\r\n      $('.a-size-base.a-color-price')\r\n    );\r\n\r\n    const outOfStock = $('#availability span').text().trim().toLowerCase() === 'currently unavailable';\r\n\r\n    const images = \r\n      $('#imgBlkFront').attr('data-a-dynamic-image') || \r\n      $('#landingImage').attr('data-a-dynamic-image') ||\r\n      '{}'\r\n\r\n    const imageUrls = Object.keys(JSON.parse(images));\r\n\r\n    const currency = extractCurrency($('.a-price-symbol'))\r\n    const discountRate = $('.savingsPercentage').text().replace(/[-%]/g, \"\");\r\n\r\n    const description = extractDescription($)\r\n     // Extract the star rating\r\n     const stars = extractStars(\r\n      $('#acrPopover'), // Example element containing the star rating\r\n      $('.averageStarRating'), \r\n      $('.a-icon-alt')\r\n    );\r\n\r\n    // Construct data object with scraped information\r\n    const data = {\r\n      url,\r\n      currency: currency || '$',\r\n      image: imageUrls[0],\r\n      title,\r\n      currentPrice: Number(currentPrice) || Number(originalPrice),\r\n      originalPrice: Number(originalPrice) || Number(currentPrice),\r\n      priceHistory: [],\r\n      discountRate: Number(discountRate),\r\n      category: 'category',\r\n      reviewsCount:100,\r\n      stars: stars,\r\n      isOutOfStock: outOfStock,\r\n      description,\r\n      lowestPrice: Number(currentPrice) || Number(originalPrice),\r\n      highestPrice: Number(originalPrice) || Number(currentPrice),\r\n      averagePrice: Number(currentPrice) || Number(originalPrice),\r\n    }\r\n\r\n    return data;\r\n  } catch (error: any) {\r\n    console.log(error);\r\n  }\r\n}"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;;;;;;AAEO,eAAe,oBAAoB,GAAW;IACnD,IAAG,CAAC,KAAK;IAET,iCAAiC;IACjC,MAAM,WAAW,OAAO,QAAQ,GAAG,CAAC,oBAAoB;IACxD,MAAM,WAAW,OAAO,QAAQ,GAAG,CAAC,oBAAoB;IACxD,MAAM,OAAO;IACb,MAAM,aAAa,AAAC,UAAU,KAAK,MAAM,KAAM;IAE/C,MAAM,UAAU;QACd,MAAM;YACJ,UAAU,GAAG,SAAS,SAAS,EAAE,YAAY;YAC7C;QACF;QACA,MAAM;QACN;QACA,oBAAoB;IACtB;IAEA,IAAI;QACF,yBAAyB;QACzB,MAAM,WAAW,MAAM,0KAAK,CAAC,GAAG,CAAC,KAAK;QACtC,MAAM,IAAI,gMAAY,CAAC,SAAS,IAAI;QAEpC,4BAA4B;QAC5B,MAAM,QAAQ,EAAE,iBAAiB,IAAI,GAAG,IAAI;QAC5C,MAAM,eAAe,IAAA,sJAAY,EAC/B,EAAE,mCACF,EAAE,+BACF,EAAE;QAGJ,MAAM,gBAAgB,IAAA,sJAAY,EAChC,EAAE,yBACF,EAAE,2CACF,EAAE,eACF,EAAE,0BACF,EAAE;QAGJ,MAAM,aAAa,EAAE,sBAAsB,IAAI,GAAG,IAAI,GAAG,WAAW,OAAO;QAE3E,MAAM,SACJ,EAAE,gBAAgB,IAAI,CAAC,2BACvB,EAAE,iBAAiB,IAAI,CAAC,2BACxB;QAEF,MAAM,YAAY,OAAO,IAAI,CAAC,KAAK,KAAK,CAAC;QAEzC,MAAM,WAAW,IAAA,yJAAe,EAAC,EAAE;QACnC,MAAM,eAAe,EAAE,sBAAsB,IAAI,GAAG,OAAO,CAAC,SAAS;QAErE,MAAM,cAAc,IAAA,4JAAkB,EAAC;QACtC,0BAA0B;QAC1B,MAAM,QAAQ,IAAA,sJAAY,EACzB,EAAE,gBACF,EAAE,uBACF,EAAE;QAGJ,iDAAiD;QACjD,MAAM,OAAO;YACX;YACA,UAAU,YAAY;YACtB,OAAO,SAAS,CAAC,EAAE;YACnB;YACA,cAAc,OAAO,iBAAiB,OAAO;YAC7C,eAAe,OAAO,kBAAkB,OAAO;YAC/C,cAAc,EAAE;YAChB,cAAc,OAAO;YACrB,UAAU;YACV,cAAa;YACb,OAAO;YACP,cAAc;YACd;YACA,aAAa,OAAO,iBAAiB,OAAO;YAC5C,cAAc,OAAO,kBAAkB,OAAO;YAC9C,cAAc,OAAO,iBAAiB,OAAO;QAC/C;QAEA,OAAO;IACT,EAAE,OAAO,OAAY;QACnB,QAAQ,GAAG,CAAC;IACd;AACF;;;IApFsB;;AAAA,yQAAA"}},
    {"offset": {"line": 459, "column": 0}, "map": {"version":3,"sources":["file:///c:/Users/User/Desktop/AmzonTrackr/lib/nodemailer/index.ts"],"sourcesContent":["\"use server\"\r\n\r\nimport { EmailContent, EmailProductInfo, NotificationType } from '@/types';\r\nimport nodemailer from 'nodemailer';\r\n\r\nconst Notification = {\r\n  WELCOME: 'WELCOME',\r\n  CHANGE_OF_STOCK: 'CHANGE_OF_STOCK',\r\n  LOWEST_PRICE: 'LOWEST_PRICE',\r\n  THRESHOLD_MET: 'THRESHOLD_MET',\r\n}\r\n\r\nexport async function generateEmailBody(\r\n  product: EmailProductInfo,\r\n  type: NotificationType\r\n  ) {\r\n  const THRESHOLD_PERCENTAGE = 40;\r\n  // Shorten the product title\r\n  const shortenedTitle =\r\n    product.title.length > 20\r\n      ? `${product.title.substring(0, 20)}...`\r\n      : product.title;\r\n\r\n  let subject = \"\";\r\n  let body = \"\";\r\n\r\n  switch (type) {\r\n    case Notification.WELCOME:\r\n      subject = `Welcome to Price Tracking for ${shortenedTitle}`;\r\n      body = `\r\n        <div>\r\n          <h2>Welcome to AmzonTrackr ðŸš€</h2>\r\n          <p>You are now tracking ${product.title}.</p>\r\n          <p>Here's an example of how you'll receive updates:</p>\r\n          <div style=\"border: 1px solid #ccc; padding: 10px; background-color: #f8f8f8;\">\r\n            <h3>${product.title} is back in stock!</h3>\r\n            <p>We're excited to let you know that ${product.title} is now back in stock.</p>\r\n            <p>Don't miss out - <a href=\"${product.url}\" target=\"_blank\" rel=\"noopener noreferrer\">buy it now</a>!</p>\r\n            <img src=\"https://i.ibb.co/pwFBRMC/Screenshot-2023-09-26-at-1-47-50-AM.png\" alt=\"Product Image\" style=\"max-width: 100%;\" />\r\n          </div>\r\n          <p>Stay tuned for more updates on ${product.title} and other products you're tracking.</p>\r\n        </div>\r\n      `;\r\n      break;\r\n\r\n    case Notification.CHANGE_OF_STOCK:\r\n      subject = `${shortenedTitle} is now back in stock!`;\r\n      body = `\r\n        <div>\r\n          <h4>Hey, ${product.title} is now restocked! Grab yours before they run out again!</h4>\r\n          <p>See the product <a href=\"${product.url}\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p>\r\n        </div>\r\n      `;\r\n      break;\r\n\r\n    case Notification.LOWEST_PRICE:\r\n      subject = `Lowest Price Alert for ${shortenedTitle}`;\r\n      body = `\r\n        <div>\r\n          <h4>Hey, ${product.title} has reached its lowest price ever!!</h4>\r\n          <p>Grab the product <a href=\"${product.url}\" target=\"_blank\" rel=\"noopener noreferrer\">here</a> now.</p>\r\n        </div>\r\n      `;\r\n      break;\r\n\r\n    case Notification.THRESHOLD_MET:\r\n      subject = `Discount Alert for ${shortenedTitle}`;\r\n      body = `\r\n        <div>\r\n          <h4>Hey, ${product.title} is now available at a discount more than ${THRESHOLD_PERCENTAGE}%!</h4>\r\n          <p>Grab it right away from <a href=\"${product.url}\" target=\"_blank\" rel=\"noopener noreferrer\">here</a>.</p>\r\n        </div>\r\n      `;\r\n      break;\r\n\r\n    default:\r\n      throw new Error(\"Invalid notification type.\");\r\n  }\r\n\r\n  return { subject, body };\r\n}\r\n\r\nconst transporter = nodemailer.createTransport({\r\n  pool: true,\r\n  service: 'hotmail',\r\n  port: 2525,\r\n  auth: {\r\n    user: process.env.EMAIL_USER,\r\n    pass: process.env.EMAIL_PASSWORD,\r\n  },\r\n  maxConnections: 1\r\n})\r\n\r\nexport const sendEmail = async (emailContent: EmailContent, sendTo: string[]) => {\r\n  const mailOptions = {\r\n    from: process.env.EMAIL_USER,\r\n    to: sendTo,\r\n    html: emailContent.body,\r\n    subject: emailContent.subject,\r\n  }\r\n\r\n  transporter.sendMail(mailOptions, (error: any, info: any) => {\r\n    if(error) return console.log(error);\r\n    \r\n    console.log('Email sent: ', info);\r\n  })\r\n}"],"names":[],"mappings":";;;;;;;AAGA;;;;AAEA,MAAM,eAAe;IACnB,SAAS;IACT,iBAAiB;IACjB,cAAc;IACd,eAAe;AACjB;AAEO,eAAe,kBACpB,OAAyB,EACzB,IAAsB;IAEtB,MAAM,uBAAuB;IAC7B,4BAA4B;IAC5B,MAAM,iBACJ,QAAQ,KAAK,CAAC,MAAM,GAAG,KACnB,GAAG,QAAQ,KAAK,CAAC,SAAS,CAAC,GAAG,IAAI,GAAG,CAAC,GACtC,QAAQ,KAAK;IAEnB,IAAI,UAAU;IACd,IAAI,OAAO;IAEX,OAAQ;QACN,KAAK,aAAa,OAAO;YACvB,UAAU,CAAC,8BAA8B,EAAE,gBAAgB;YAC3D,OAAO,CAAC;;;kCAGoB,EAAE,QAAQ,KAAK,CAAC;;;gBAGlC,EAAE,QAAQ,KAAK,CAAC;kDACkB,EAAE,QAAQ,KAAK,CAAC;yCACzB,EAAE,QAAQ,GAAG,CAAC;;;4CAGX,EAAE,QAAQ,KAAK,CAAC;;MAEtD,CAAC;YACD;QAEF,KAAK,aAAa,eAAe;YAC/B,UAAU,GAAG,eAAe,sBAAsB,CAAC;YACnD,OAAO,CAAC;;mBAEK,EAAE,QAAQ,KAAK,CAAC;sCACG,EAAE,QAAQ,GAAG,CAAC;;MAE9C,CAAC;YACD;QAEF,KAAK,aAAa,YAAY;YAC5B,UAAU,CAAC,uBAAuB,EAAE,gBAAgB;YACpD,OAAO,CAAC;;mBAEK,EAAE,QAAQ,KAAK,CAAC;uCACI,EAAE,QAAQ,GAAG,CAAC;;MAE/C,CAAC;YACD;QAEF,KAAK,aAAa,aAAa;YAC7B,UAAU,CAAC,mBAAmB,EAAE,gBAAgB;YAChD,OAAO,CAAC;;mBAEK,EAAE,QAAQ,KAAK,CAAC,0CAA0C,EAAE,qBAAqB;8CACtD,EAAE,QAAQ,GAAG,CAAC;;MAEtD,CAAC;YACD;QAEF;YACE,MAAM,IAAI,MAAM;IACpB;IAEA,OAAO;QAAE;QAAS;IAAK;AACzB;AAEA,MAAM,cAAc,oLAAU,CAAC,eAAe,CAAC;IAC7C,MAAM;IACN,SAAS;IACT,MAAM;IACN,MAAM;QACJ,MAAM,QAAQ,GAAG,CAAC,UAAU;QAC5B,MAAM,QAAQ,GAAG,CAAC,cAAc;IAClC;IACA,gBAAgB;AAClB;AAEO,MAAM,YAAY,OAAO,cAA4B;IAC1D,MAAM,cAAc;QAClB,MAAM,QAAQ,GAAG,CAAC,UAAU;QAC5B,IAAI;QACJ,MAAM,aAAa,IAAI;QACvB,SAAS,aAAa,OAAO;IAC/B;IAEA,YAAY,QAAQ,CAAC,aAAa,CAAC,OAAY;QAC7C,IAAG,OAAO,OAAO,QAAQ,GAAG,CAAC;QAE7B,QAAQ,GAAG,CAAC,gBAAgB;IAC9B;AACF;;;IA9FsB;IAiFT;;AAjFS,yQAAA;AAiFT,yQAAA"}},
    {"offset": {"line": 568, "column": 0}, "map": {"version":3,"sources":["file:///c:/Users/User/Desktop/AmzonTrackr/lib/actions/index.ts"],"sourcesContent":["\"use server\"\r\n\r\nimport { revalidatePath } from \"next/cache\";\r\nimport Product from \"../models/product.model\";\r\nimport { connectToDB } from \"../mongoose\";\r\nimport { scrapeAmazonProduct } from \"../scraper\";\r\nimport { getAveragePrice, getHighestPrice, getLowestPrice } from \"../utils\";\r\nimport { User } from \"@/types\";\r\nimport { generateEmailBody, sendEmail } from \"../nodemailer\";\r\n\r\nexport async function scrapeAndStoreProduct(productUrl: string) {\r\n  if(!productUrl) return;\r\n\r\n  try {\r\n    await connectToDB();\r\n\r\n    const scrapedProduct = await scrapeAmazonProduct(productUrl);\r\n\r\n    if(!scrapedProduct) return;\r\n\r\n    let product = scrapedProduct;\r\n\r\n    const existingProduct = await Product.findOne({ url: scrapedProduct.url });\r\n\r\n    if(existingProduct) {\r\n      const updatedPriceHistory: any = [\r\n        ...existingProduct.priceHistory,\r\n        { price: scrapedProduct.currentPrice }\r\n      ]\r\n\r\n      product = {\r\n        ...scrapedProduct,\r\n        priceHistory: updatedPriceHistory,\r\n        lowestPrice: getLowestPrice(updatedPriceHistory),\r\n        highestPrice: getHighestPrice(updatedPriceHistory),\r\n        averagePrice: getAveragePrice(updatedPriceHistory),\r\n      }\r\n    }\r\n\r\n    const newProduct = await Product.findOneAndUpdate(\r\n      { url: scrapedProduct.url },\r\n      product,\r\n      { upsert: true, new: true }\r\n    );\r\n\r\n    revalidatePath(`/products/${newProduct._id}`);\r\n    return newProduct; // Return the new or updated product\r\n  } catch (error: any) {\r\n    throw new Error(`Failed to create/update product: ${error.message}`)\r\n  }\r\n}\r\n\r\nexport async function getProductById(productId: string) {\r\n  try {\r\n    await connectToDB();\r\n\r\n    const product = await Product.findOne({ _id: productId });\r\n\r\n    if(!product) return null;\r\n\r\n    return product;\r\n  } catch (error) {\r\n    console.log(error);\r\n  }\r\n}\r\n\r\nexport async function getAllProducts() {\r\n  try {\r\n    await connectToDB();\r\n\r\n    const products = await Product.find();\r\n\r\n    return products;\r\n  } catch (error) {\r\n    console.log(error);\r\n  }\r\n}\r\n\r\nexport async function getSimilarProducts(productId: string) {\r\n  try {\r\n    await connectToDB();\r\n\r\n    const currentProduct = await Product.findById(productId);\r\n\r\n    if(!currentProduct) return null;\r\n\r\n    const similarProducts = await Product.find({\r\n      _id: { $ne: productId },\r\n    }).limit(3);\r\n\r\n    return similarProducts;\r\n  } catch (error) {\r\n    console.log(error);\r\n  }\r\n}\r\n\r\nexport async function addUserEmailToProduct(productId: string, userEmail: string) {\r\n  try {\r\n    await connectToDB();\r\n\r\n    const product = await Product.findById(productId);\r\n\r\n    if(!product) return;\r\n\r\n    const userExists = product.users.some((user: User) => user.email === userEmail);\r\n\r\n    if(!userExists) {\r\n      product.users.push({ email: userEmail });\r\n\r\n      await product.save();\r\n\r\n      const emailContent = await generateEmailBody(product, \"WELCOME\");\r\n\r\n      await sendEmail(emailContent, [userEmail]);\r\n    }\r\n  } catch (error) {\r\n    console.log(error);\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;;;;;;;AAEA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;AAEO,eAAe,sBAAsB,UAAkB;IAC5D,IAAG,CAAC,YAAY;IAEhB,IAAI;QACF,MAAM,IAAA,wJAAW;QAEjB,MAAM,iBAAiB,MAAM,IAAA,wKAAmB,EAAC;QAEjD,IAAG,CAAC,gBAAgB;QAEpB,IAAI,UAAU;QAEd,MAAM,kBAAkB,MAAM,sKAAO,CAAC,OAAO,CAAC;YAAE,KAAK,eAAe,GAAG;QAAC;QAExE,IAAG,iBAAiB;YAClB,MAAM,sBAA2B;mBAC5B,gBAAgB,YAAY;gBAC/B;oBAAE,OAAO,eAAe,YAAY;gBAAC;aACtC;YAED,UAAU;gBACR,GAAG,cAAc;gBACjB,cAAc;gBACd,aAAa,IAAA,wJAAc,EAAC;gBAC5B,cAAc,IAAA,yJAAe,EAAC;gBAC9B,cAAc,IAAA,yJAAe,EAAC;YAChC;QACF;QAEA,MAAM,aAAa,MAAM,sKAAO,CAAC,gBAAgB,CAC/C;YAAE,KAAK,eAAe,GAAG;QAAC,GAC1B,SACA;YAAE,QAAQ;YAAM,KAAK;QAAK;QAG5B,IAAA,yKAAc,EAAC,CAAC,UAAU,EAAE,WAAW,GAAG,EAAE;QAC5C,OAAO,YAAY,oCAAoC;IACzD,EAAE,OAAO,OAAY;QACnB,MAAM,IAAI,MAAM,CAAC,iCAAiC,EAAE,MAAM,OAAO,EAAE;IACrE;AACF;AAEO,eAAe,eAAe,SAAiB;IACpD,IAAI;QACF,MAAM,IAAA,wJAAW;QAEjB,MAAM,UAAU,MAAM,sKAAO,CAAC,OAAO,CAAC;YAAE,KAAK;QAAU;QAEvD,IAAG,CAAC,SAAS,OAAO;QAEpB,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,GAAG,CAAC;IACd;AACF;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,IAAA,wJAAW;QAEjB,MAAM,WAAW,MAAM,sKAAO,CAAC,IAAI;QAEnC,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,GAAG,CAAC;IACd;AACF;AAEO,eAAe,mBAAmB,SAAiB;IACxD,IAAI;QACF,MAAM,IAAA,wJAAW;QAEjB,MAAM,iBAAiB,MAAM,sKAAO,CAAC,QAAQ,CAAC;QAE9C,IAAG,CAAC,gBAAgB,OAAO;QAE3B,MAAM,kBAAkB,MAAM,sKAAO,CAAC,IAAI,CAAC;YACzC,KAAK;gBAAE,KAAK;YAAU;QACxB,GAAG,KAAK,CAAC;QAET,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,GAAG,CAAC;IACd;AACF;AAEO,eAAe,sBAAsB,SAAiB,EAAE,SAAiB;IAC9E,IAAI;QACF,MAAM,IAAA,wJAAW;QAEjB,MAAM,UAAU,MAAM,sKAAO,CAAC,QAAQ,CAAC;QAEvC,IAAG,CAAC,SAAS;QAEb,MAAM,aAAa,QAAQ,KAAK,CAAC,IAAI,CAAC,CAAC,OAAe,KAAK,KAAK,KAAK;QAErE,IAAG,CAAC,YAAY;YACd,QAAQ,KAAK,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAU;YAEtC,MAAM,QAAQ,IAAI;YAElB,MAAM,eAAe,MAAM,IAAA,yKAAiB,EAAC,SAAS;YAEtD,MAAM,IAAA,iKAAS,EAAC,cAAc;gBAAC;aAAU;QAC3C;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,GAAG,CAAC;IACd;AACF;;;IA5GsB;IA0CA;IAcA;IAYA;IAkBA;;AAtFA,yQAAA;AA0CA,yQAAA;AAcA,yQAAA;AAYA,yQAAA;AAkBA,yQAAA"}},
    {"offset": {"line": 705, "column": 0}, "map": {"version":3,"sources":["file:///c:/Users/User/Desktop/AmzonTrackr/.next-internal/server/app/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getAllProducts as '0077f5be66dcda5b8b74459d20a9eea3cac253cf6c'} from 'ACTIONS_MODULE0'\nexport {getSimilarProducts as '402a1f54f13114a1f21af2d4eadf55626c310f6658'} from 'ACTIONS_MODULE0'\nexport {scrapeAndStoreProduct as '40a331ea1b1925a2015ae41f722c2b57fc6e7023ae'} from 'ACTIONS_MODULE0'\nexport {getProductById as '40b5fd01365bcdb7c5abac93baab7f887afeb608ca'} from 'ACTIONS_MODULE0'\nexport {addUserEmailToProduct as '60fc020723cf5c412fe886014f51c64660de6428f3'} from 'ACTIONS_MODULE0'\nexport {scrapeAmazonProduct as '4043449b66c9acb04a5d087fe2af1ceca53bbf7832'} from 'ACTIONS_MODULE1'\nexport {generateEmailBody as '60747665298e842d6d77c6c3e8c3808f9157d4e3c9'} from 'ACTIONS_MODULE2'\nexport {sendEmail as '7fc2543ef284d4046fc084ce2920e10d349ad52a4f'} from 'ACTIONS_MODULE2'\nexport {scrapeAndStoreProduct as '40a331ea1b1925a2015ae41f722c2b57fc6e7023ae'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA;AAKA;AACA"}}]
}